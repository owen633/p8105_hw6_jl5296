---
title: "HW 6"
author: "Jianyou Liu"
date: "November 25, 2018"
output: github_document
---

```{r setup, include=FALSE}

library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))

```

## Problem 1
### Load in dataset

```{r import_raw_data, message=FALSE}
raw_hom_data = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

head(raw_hom_data)

```

#### Create city_state variable and binary variable indicating whether the homicide is solved

```{r mutate_data}
new_hom_data1 = raw_hom_data %>% 
  unite(city, state, col = "city_state", sep = ",") %>% 
  mutate(bin_solved = ifelse(disposition == "Closed without arrest" | disposition == "Open/No arrest", 0, 1))

```
**Note**: '0' = crime unsolved; '1' = crime solved

#### Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake
```{r filter_data}
new_hom_data2 = new_hom_data1 %>% 
  filter(city_state != "Dallas,TX", city_state != "Phoenix,AZ", city_state != "Kansas City,MO", city_state != "Tulsa,AL")

```
#### Modifiy victim_race to have categories white and non-white, with white as the reference category. Make sure that victim_age is a numeric variable.

```{r manipuate_data}
final_hom_data = new_hom_data2 %>% 
  mutate(victim_race = ifelse(victim_race == "White", "White", "Non-White"),
  # Make 'White' as the reference category
  victim_race = fct_relevel(victim_race, ref = "White")) %>% 
  # Convert 'victim_age' into numeric
  mutate(victim_age = as.numeric(victim_age))

head(final_hom_data, n = 10)

```
### Baltimore, MD Linear Model Analysis
#### Fit logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors.

```{r baltimore_glm}
balt_data = final_hom_data %>% 
  filter(city_state == "Baltimore,MD")

# Save output as R object
fit_glm_balt = balt_data %>% 
  glm(bin_solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

```
#### Apply broom::tidy to the object and extract estimate and confidence interval of the adjusted odds ratio

```{r baltimore_est_ci}
fit_glm_balt %>% 
  broom::tidy() %>% 
  # Transform log 'Odds Ratio' back; calculate 95% CIs
  mutate(OR = exp(estimate), low_CI = exp(estimate - std.error*1.96), high_CI = exp(estimate + std.error*1.96)) %>% 
  select(term, OR, low_CI, high_CI, p.value) %>% 
  # Compare 'non-white' to 'white victims'
  filter(term == "victim_raceNon-White") %>% 
  knitr::kable(digits = 3)

```
**Interpretation**: We can be 95% confident that the odds of resolving a homicide case is between 0.322 and 0.637 times among *non-white* victims than that of *white* victims.

### All City Analysis
#### Run logistic regression for each of the cities; extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims

```{r glm_all}
fit_glm_all = final_hom_data %>% 
  group_by(city_state) %>% 
  # Generate list column
  nest() %>% 
  # Perform glm and broom;tidy for each city
  mutate(logis_model = map(data, ~glm(bin_solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())), logis_model = map(logis_model, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  # Obtain odds ratio and compute 95% confidence intervals
  mutate(OR = exp(estimate), low_CI = exp(estimate - std.error*1.96), high_CI = exp(estimate + std.error*1.96)) %>% 
  select(city_state, term, OR, low_CI, high_CI, p.value) %>% 
  filter(term == "victim_raceNon-White")

# Display first 10 rows of resulting data frame
head(fit_glm_all, n = 10) %>% 
  knitr::kable(digits = 3)
  
```

#### Create a plot that shows the estimated ORs and CIs for each city

```{r plot_all_city}
fit_glm_all %>% 
  # Organize cities according to increasing estimated ORs
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point(alpha = .5) +
  geom_errorbar(aes(ymin = low_CI , ymax = high_CI), color = "blue") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Estimates of OR and CIs for each City for Whites vs. Non - Whites",
    x = "City",
    y = "Estimated Adjusted OR"
  )

```


